<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Classroom Admin â€” Groundâ€‘Up</title>
  <style>
    :root{--bg:#0b1020;--panel:#0f172a;--panel2:#111827;--muted:#9aa6b2;--text:#e7e9ee;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--accent:#60a5fa;--border:#1e293b}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;z-index:3;background:#0a0f1f;border-bottom:1px solid var(--border);padding:14px 16px}
    h1{margin:0;font-size:18px}
    main{display:grid;grid-template-columns:380px 1fr;gap:16px;padding:16px}
    @media (max-width:980px){main{grid-template-columns:1fr}}
    section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px}
    label{display:block;font-size:12px;color:var(--muted);margin:8px 0 4px}
    input,select,button{font:inherit}
    input[type="text"],input[type="number"],select{width:100%;padding:10px 12px;background:var(--panel2);border:1px solid var(--border);border-radius:10px;color:var(--text)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:6px;padding:9px 12px;background:var(--panel2);border:1px solid var(--border);border-radius:10px;color:var(--text);cursor:pointer}
    .btn.primary{border-color:var(--accent)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .log{height:160px;background:#000;color:#9efca0;border-radius:10px;border:1px solid var(--border);padding:10px;overflow:auto;font-family:ui-monospace,Menlo,Consolas,monospace}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border)}
    th{position:sticky;top:0;background:var(--panel);color:var(--muted);text-align:left}
    tr.add td{background:rgba(34,197,94,.06)}
    tr.edit td{background:rgba(59,130,246,.06)}
    tr.del td{background:rgba(239,68,68,.06);text-decoration:line-through}
    .chip{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:var(--panel2);border:1px solid var(--border);color:var(--muted)}
    .status{display:flex;align-items:center;gap:8px}
    .status .dot{width:8px;height:8px;border-radius:999px;background:#999}
    .status.signedout .dot{background:#666}
    .status.signedin .dot{background:#10b981}
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“‹ Classroom Admin</h1>
  </header>

  <main>
    <section>
      <div class="status signedout" id="authStatus"><span class="dot"></span><span id="authText">Signed out</span></div>
      <div class="toolbar" style="margin:10px 0 6px">
        <button class="btn" id="btnSignIn">Sign in with Google</button>
        <button class="btn" id="btnSignOut" disabled>Sign out</button>
      </div>

      <label>Available Classes</label>
      <div class="toolbar">
        <select id="classSelect" style="min-width:220px"></select>
        <button class="btn" id="btnRefreshClasses">â†» Refresh</button>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Class Name</label>
          <input id="className" type="text" placeholder="Grade5" />
        </div>
        <div>
          <label>Student ID Prefix</label>
          <input id="idPrefix" type="text" placeholder="G5_" />
        </div>
      </div>

      <div class="toolbar" style="margin-top:10px">
        <button id="btnLoad" class="btn primary">Load Class</button>
        <button id="btnListen" class="btn">Live Listen: Off</button>
        <button id="btnExport" class="btn">Export CSV</button>
      </div>

      <div class="toolbar" style="margin:10px 0">
        <span class="chip">Inline edit</span>
        <span class="chip">Add/Delete</span>
        <span class="chip">Batch save</span>
      </div>

      <div class="toolbar">
        <button id="btnAdd" class="btn">+ Add Student</button>
        <button id="btnSave" class="btn primary" disabled>Save Changes</button>
        <button id="btnDiscard" class="btn" disabled>Discard</button>
      </div>

      <label style="margin-top:12px">Change Log</label>
      <pre id="log" class="log"></pre>

      <label style="margin-top:12px">CSV/TXT Import</label>
      <div class="row">
        <div><input id="file" type="file" accept=".csv,.txt" /></div>
        <div>
          <select id="importMode">
            <option value="append">Append</option>
            <option value="replace">Replace</option>
          </select>
        </div>
      </div>
      <div class="toolbar" style="margin-top:8px">
        <button id="btnImportDry" class="btn">Dry Run</button>
        <button id="btnImportCommit" class="btn" disabled>Commit</button>
      </div>
    </section>

    <section>
      <div style="overflow:auto;max-height:70vh;border:1px solid var(--border);border-radius:10px;background:var(--panel)">
        <table id="table">
          <thead>
            <tr>
              <th style="width:60px">#</th>
              <th style="width:200px">Student ID</th>
              <th>Name</th>
              <th style="width:120px">Points</th>
              <th style="width:160px">Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { signInWithRedirect } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, writeBatch, setDoc, serverTimestamp, collection, getDocs, onSnapshot, query } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = { apiKey:"AIzaSyDNNuSuHAqpms8UvOTCDmrEnXN648eTkxo", authDomain:"classroompoints.firebaseapp.com", projectId:"classroompoints", storageBucket:"classroompoints.firebasestorage.app", messagingSenderId:"176805498618", appId:"1:176805498618:web:2071d90825bafb78154343", measurementId:"G-BLJYG5JYQW" };
  const app = initializeApp(firebaseConfig);
  if (location.protocol === 'file:') {
    console.warn('Firebase Auth will not work from file://. Please serve over http:// or https://');
  }
  const db = getFirestore(app); window.db = db;
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // === Auth gating (sign-in required for all features) ===
const isSignedIn = () => !!auth.currentUser;

  const $ = s => document.querySelector(s);
  const byId = id => document.getElementById(id);
  const log = (...a) => { const el = byId("log"); el.textContent += a.join(" ") + "\n"; el.scrollTop = el.scrollHeight; };
  const tbl = $("#table tbody");

  let currentClass = "";
  let unsubscribe = null;
  let rows = [];
  let staged = { add:new Map(), edit:new Map(), del:new Map() };

  const int = (n) => Math.max(0, Math.trunc(Number(n)||0));

  function digitsFrom(s){ return Array.from(s||"").filter(ch=>ch>="0"&&ch<="9").join(""); }
  function prefixFor(n){ const d = digitsFrom(n); return d?`G${d}_`:""; }
  function ensurePrefixFilled(){ const pref = byId("idPrefix").value.trim(); if(!pref) byId("idPrefix").value = prefixFor(byId("className").value.trim()); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m])); }
  function setDirty(){ byId("btnSave").disabled=false; byId("btnDiscard").disabled=false; }
  function resetState(){ rows=[]; staged={ add:new Map(), edit:new Map(), del:new Map() }; renderTable(); byId("btnSave").disabled=true; byId("btnDiscard").disabled=true; log("--- state cleared ---"); }

  function setAuthUI(user){
    const st = byId("authStatus"); const txt = byId("authText");
    const signedIn = !!user;

    if(signedIn){
      st.classList.remove("signedout"); st.classList.add("signedin");
      txt.textContent = `Signed in as ${user.email}`;
      byId("btnSignOut").disabled = false;
    }else{
      st.classList.remove("signedin"); st.classList.add("signedout");
      txt.textContent = "Signed out";
      byId("btnSignOut").disabled = true;
    }

    // Disable everything when signed out; enable base controls when signed in.
    const allIds = [
      "btnRefreshClasses","classSelect","className","idPrefix","btnLoad","btnListen","btnExport",
      "btnAdd","btnSave","btnDiscard","file","importMode","btnImportDry","btnImportCommit"
    ];
    if(!signedIn){
      allIds.forEach(id=>{ const el=byId(id); if(el) el.disabled = true; });
    } else {
      ["btnRefreshClasses","classSelect","className","idPrefix","btnLoad","btnListen","btnExport","btnAdd","file","importMode","btnImportDry"].forEach(id=>{ const el=byId(id); if(el) el.disabled = false; });
      // btnSave / btnDiscard / btnImportCommit remain as-is (respect dirty state and dry-run flow)
    }
  }${trusted?" (trusted)":""}`; byId("btnSignOut").disabled=false; }
    else { st.classList.remove("signedin"); st.classList.add("signedout"); txt.textContent = "Signed out"; byId("btnSignOut").disabled=true; }

    // Gate write-ish actions behind trusted auth
    const writeButtons = ["btnSave","btnDiscard","btnAdd","btnImportCommit","btnImportDry"]; // keep Dry gated for simplicity
    writeButtons.forEach(id=>{ const el=byId(id); if(el) el.disabled = !trusted; });
  }

  function renderTable(){
    tbl.innerHTML = "";
    rows.forEach((r,i)=>{
      const tr = document.createElement("tr");
      if(r._state==="add") tr.classList.add("add");
      if(r._state==="edit") tr.classList.add("edit");
      if(r._state==="del") tr.classList.add("del");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td><input class="cell id" value="${escapeHtml(r.id)}" ${r._state==="del"?"disabled":""}></td>
        <td><input class="cell name" value="${escapeHtml(r.name||"")}" ${r._state==="del"?"disabled":""}></td>
        <td><input class="cell points" type="number" min="0" value="${int(r.points||0)}" ${r._state==="del"?"disabled":""}></td>
        <td>
          <div class="toolbar">
            <button class="btn btnDel">${r._state==="del"?"Undo":"Delete"}</button>
            <button class="btn btnInc">+1</button>
            <button class="btn btnDec">-1</button>
          </div>
        </td>`;
      tbl.appendChild(tr);
      const [idEl,nameEl,ptsEl] = tr.querySelectorAll("input.cell");
      tr.querySelector(".btnDel").addEventListener("click",()=>toggleDelete(i));
      tr.querySelector(".btnInc").addEventListener("click",()=>adjustPoints(i,1));
      tr.querySelector(".btnDec").addEventListener("click",()=>adjustPoints(i,-1));
      idEl.addEventListener("change",()=>markEdit(i,{ id:idEl.value.trim() }));
      nameEl.addEventListener("change",()=>markEdit(i,{ name:nameEl.value }));
      ptsEl.addEventListener("change",()=>markEdit(i,{ points:int(ptsEl.value) }));
    });
  }

  function toggleDelete(idx){ const r=rows[idx]; if(r._state==="del"){ r._state=r._origState||undefined; staged.del.delete(r._origId||r.id); } else { r._origState=r._state; r._state="del"; r._origId=r.id; staged.del.set(r.id,true); staged.add.delete(r.id); staged.edit.delete(r.id); } setDirty(); renderTable(); }
  function adjustPoints(idx,delta){ const r=rows[idx]; if(r._state==="del") return; const next=int((r.points||0)+delta); rows[idx].points=next; staged.edit.set(r.id,{ ...(staged.edit.get(r.id)||{}), points:next }); setDirty(); renderTable(); }
  function markEdit(idx,patch){ const r=rows[idx]; if(r._state==="del") return; const oldId=r.id; Object.assign(r,patch); if(patch.id && patch.id!==oldId){ staged.del.set(oldId,true); staged.add.set(r.id,{ id:r.id, name:r.name||"", points:int(r.points||0) }); r._state="edit"; } else { if(patch.points!==undefined) patch.points=int(patch.points); staged.edit.set(r.id,{ ...(staged.edit.get(r.id)||{}), ...patch }); if(r._state!=="add") r._state="edit"; } setDirty(); renderTable(); }
  function addRow(){ ensurePrefixFilled(); const pref=byId("idPrefix").value.trim(); let i=1; while(rows.find(r=>r.id===`${pref}${String(i).padStart(4,"0")}`)) i++; const id=`${pref}${String(i).padStart(4,"0")}`; const r={ id, name:"", points:0, _state:"add" }; rows.push(r); staged.add.set(id,{ id, name:"", points:0 }); setDirty(); renderTable(); }

  async function ensureClassDocExists(name){ try{ await setDoc(doc(db,"classes",name),{ updatedAt:serverTimestamp() },{ merge:true }); }catch(e){ log("ensureClassDocExists:", e.code||e.message); } }

  async function refreshClasses(){ const select=byId("classSelect"); select.innerHTML=""; try{ const s=await getDocs(query(collection(db,"classes"))); const list=[]; s.forEach(d=>list.push(d.id)); list.sort((a,b)=>a.localeCompare(b,undefined,{numeric:true})); if(!list.length){ const opt=document.createElement("option"); opt.value=""; opt.textContent="(none found)"; select.appendChild(opt); } else { for(const v of list){ const opt=document.createElement("option"); opt.value=v; opt.textContent=v; select.appendChild(opt); } } log(`Found ${list.length} classes.`); }catch(e){ log("classes read:", e.code||e.message); } }

  async function loadClass({live=false}={}){
    const className = byId("className").value.trim();
    if(!className){ alert("Enter a class name"); return; }
    currentClass = className;
    await ensureClassDocExists(currentClass);
    ensurePrefixFilled();
    resetState();
    if(unsubscribe){ unsubscribe(); unsubscribe=null; }
    const coll = collection(db,"classes",className,"students");
    if(live){
      unsubscribe = onSnapshot(query(coll),(snap)=>{ rows=[]; snap.forEach(d=>rows.push({ id:d.id, name:d.data().name||"", points:int(d.data().points||0) })); renderTable(); log(`Live update: ${rows.length} students`); }, (err)=>log("students listen:", err.code||err.message));
    }else{
      try{ const snap = await getDocs(query(coll)); rows=[]; snap.forEach(d=>rows.push({ id:d.id, name:d.data().name||"", points:int(d.data().points||0) })); renderTable(); log(`Loaded ${rows.length} students for ${className}`); }catch(e){ log("students read:", e.code||e.message); }
    }
  }

  async function saveChanges(){
    if(!currentClass){ alert("Load a class first."); return; }
    if(!isSignedIn()){ alert("Sign in to save changes."); return; }
    const batch = writeBatch(db);
    staged.del.forEach((_,id)=>batch.delete(doc(db,"classes",currentClass,"students",id)));
    staged.add.forEach((data,id)=>batch.set(doc(db,"classes",currentClass,"students",id),{ id:data.id, name:data.name||"", points:int(data.points||0) },{ merge:true }));
    staged.edit.forEach((patch,id)=>{ if(!staged.add.has(id)) batch.set(doc(db,"classes",currentClass,"students",id),{ ...(patch.name!==undefined?{name:patch.name}:{}) , ...(patch.points!==undefined?{points:int(patch.points)}:{}) },{ merge:true }); });
    const total = staged.del.size + staged.add.size + staged.edit.size; if(!total){ log("No changes to save."); return; }
    await batch.commit();
    await ensureClassDocExists(currentClass);
    log(`Saved: del=${staged.del.size} add=${staged.add.size} edit=${staged.edit.size}`);
    rows = rows.filter(r=>r._state!=="del").map(r=>({ id:r.id, name:r.name, points:int(r.points) }));
    staged = { add:new Map(), edit:new Map(), del:new Map() };
    byId("btnSave").disabled=true; byId("btnDiscard").disabled=true; renderTable();
  }

  function discardChanges(){ loadClass({ live:!!unsubscribe }); }

  async function exportCSV(){ if(!currentClass){ alert("Load a class first."); return; } const rowsOut=[["id","name","points"],...rows.map(r=>[r.id,r.name||"",int(r.points||0)])]; const csv=rowsOut.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n"); const blob=new Blob([csv],{type:"text/csv"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`${currentClass}_students.csv`; document.body.appendChild(a); a.click(); a.remove(); }
  function parseFileToNames(text){ const clean=(text||"").replaceAll("\r",""); return clean.split("\n").map(l=>l.trim()).filter(Boolean).map(l=>l.split(",")[0].trim()).filter(Boolean); }

  async function importDry(){ if(!currentClass){ alert("Load a class first."); return; } if(!isSignedIn()){ alert("Sign in to run import."); return; } const f=byId("file"); if(!f.files||!f.files.length){ alert("Choose a CSV/TXT file."); return; } const text=await f.files[0].text(); const names=parseFileToNames(text); if(!names.length){ alert("No names detected in file."); return; } const pref=byId("idPrefix").value.trim()||prefixFor(currentClass); let idx=1; while(rows.find(r=>r.id===`${pref}${String(idx).padStart(4,"0")}`)) idx++; const plan=[]; for(const name of names){ const id=`${pref}${String(idx++).padStart(4,"0")}`; const exists=rows.find(r=>r.id===id); plan.push({ id,name,exists }); } log(`Dry Run: ${plan.filter(p=>!p.exists).length} to add, ${plan.filter(p=>p.exists).length} already exist.`); byId("btnImportCommit").disabled=false; byId("btnImportCommit")._plan=plan; }

  async function importCommit(){ const plan=byId("btnImportCommit")._plan||[]; if(!plan.length){ alert("Run Dry Run first."); return; } if(!isSignedIn()){ alert("Sign in to import."); return; } const mode=byId("importMode").value; const batch=writeBatch(db); const base=["classes",currentClass,"students"]; if(mode==="replace"){ const keep=new Set(plan.map(p=>p.id)); for(const r of rows){ if(!keep.has(r.id)) batch.delete(doc(db,...base,r.id)); } } for(const p of plan){ batch.set(doc(db,...base,p.id),{ id:p.id,name:p.name,points:0 },{ merge:true }); } await batch.commit(); log(`Import committed: ${plan.length} rows (mode=${mode})`); byId("btnImportCommit").disabled=true; loadClass({ live:!!unsubscribe }); }

  byId("btnLoad").addEventListener("click",()=>loadClass({ live:false }));
  byId("btnListen").addEventListener("click",async e=>{ const on=!!unsubscribe; if(on){ unsubscribe(); unsubscribe=null; e.target.textContent="Live Listen: Off"; } else { await loadClass({ live:true }); e.target.textContent="Live Listen: On"; } });
  byId("btnExport").addEventListener("click",exportCSV);
  byId("btnAdd").addEventListener("click",addRow);
  byId("btnSave").addEventListener("click",saveChanges);
  byId("btnDiscard").addEventListener("click",discardChanges);
  byId("btnImportDry").addEventListener("click",importDry);
  byId("btnImportCommit").addEventListener("click",importCommit);
  byId("btnRefreshClasses").addEventListener("click",refreshClasses);
  byId("classSelect").addEventListener("change",e=>{ const v=e.target.value; if(!v) return; byId("className").value=v; ensurePrefixFilled(); });
  byId("btnSignIn").addEventListener("click", async () => {
    try {
      await signInWithPopup(auth, provider);
    } catch (e) {
      log("auth:", e.code || e.message);
      if (e.code === 'auth/configuration-not-found' || e.code === 'auth/operation-not-allowed') {
        log("Hint: Enable Google provider in Firebase Console â†’ Authentication â†’ Sign-in method, and add this origin under Authorized domains.");
      }
      if (e.code === 'auth/popup-blocked' || e.code === 'auth/popup-closed-by-user') {
        log("Retrying with redirect flow...");
        try { await signInWithRedirect(auth, provider); }
        catch (e2) { log("auth redirect:", e2.code || e2.message); }
      }
    }
  });
  byId("btnSignOut").addEventListener("click",async()=>{ try{ await signOut(auth);}catch(e){ log("auth:", e.code||e.message); }});

  onAuthStateChanged(auth,(user)=>{
    setAuthUI(user);
    if(user){
      refreshClasses();
    } else {
      // Clear UI when signed out
      const select = byId("classSelect"); if(select) select.innerHTML = "";
      tbl.innerHTML = "";
      log("Sign in to view classes.");
    }
  });
</script>
</body>
</html>

